name: iOS Build (Free - No Mac Required)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest  # GitHub provides free macOS runners!

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ“± Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.7'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ğŸ” Flutter Doctor
      run: flutter doctor -v

    - name: ğŸ“Š Analyze Code
      run: flutter analyze
      continue-on-error: true

    - name: ğŸ§ª Run Tests
      run: flutter test
      continue-on-error: true

    - name: ğŸ Install CocoaPods
      run: |
        cd ios
        pod install --repo-update
        cd ..

    - name: ğŸ—ï¸ Build iOS (No Code Sign - For Testing)
      run: |
        flutter build ios --release --no-codesign

    - name: ğŸ“¦ Create IPA Archive
      run: |
        mkdir -p Payload
        cp -r build/ios/iphoneos/Runner.app Payload/
        zip -r family_travel_app.ipa Payload

    - name: ğŸ“¤ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-unsigned
        path: family_travel_app.ipa
        retention-days: 30

    - name: ğŸ“Š Build Summary
      run: |
        echo "âœ… iOS Build Complete!"
        echo "ğŸ“± Download IPA from Actions artifacts"
        echo "ğŸ”— Install via: https://www.diawi.com/"
        ls -lh family_travel_app.ipa

  # Signed build (requires Apple Developer secrets)
  build-ios-signed:
    name: Build Signed iOS IPA
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.signed == 'true'  # Only manual trigger with flag

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“± Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.7'
        channel: 'stable'

    - name: ğŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ğŸ” Install Apple Certificate
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      run: |
        # Create temp keychain
        security create-keychain -p temp_password temp.keychain
        security default-keychain -s temp.keychain
        security unlock-keychain -p temp_password temp.keychain
        
        # Import certificate
        echo $IOS_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
        security import certificate.p12 -k temp.keychain -P $IOS_CERTIFICATE_PASSWORD -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k temp_password temp.keychain

    - name: ğŸ“± Install Provisioning Profile
      env:
        IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo $IOS_PROVISION_PROFILE_BASE64 | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

    - name: ğŸ Install Pods
      run: |
        cd ios
        pod install
        cd ..

    - name: ğŸ—ï¸ Build Signed IPA
      run: |
        flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

    - name: ğŸ“¤ Upload Signed IPA
      uses: actions/upload-artifact@v3
      with:
        name: ios-ipa-signed
        path: build/ios/ipa/*.ipa
        retention-days: 30

  # Android build for comparison
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ“± Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.7'
        channel: 'stable'

    - name: ğŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ğŸ¤– Build APK
      run: flutter build apk --release --split-per-abi

    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/*.apk
        retention-days: 30

